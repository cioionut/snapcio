"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[851],{3851:function(e,n,t){t.r(n),t.d(n,{WebRTCContext:function(){return d},WebRTCContextProvider:function(){return h}});var a=t(4051),r=t.n(a),c=t(5893),o=t(7294),i=t(8158),s=t(7658);function u(e,n,t,a,r,c,o){try{var i=e[c](o),s=i.value}catch(u){return void t(u)}i.done?n(s):Promise.resolve(s).then(a,r)}function l(e){return function(){var n=this,t=arguments;return new Promise((function(a,r){var c=e.apply(n,t);function o(e){u(c,a,r,o,i,"next",e)}function i(e){u(c,a,r,o,i,"throw",e)}o(void 0)}))}}var f={iceServers:[{urls:"stun:".concat("turn.gcp1.ionkom.com:3478")},{urls:"turn:".concat("turn.gcp1.ionkom.com:3478"),username:"ionkom",credential:"mgzvolNHkyEjW7KvXuPe"}]},d=(0,o.createContext)({nextUser:function(){},hangUpCall:function(){},joinConv:function(){},stopConv:function(){},availableUsers:[],myUsername:void 0,targetUsername:void 0,peerConnection:null});function p(e){var n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function v(e){!function(e){var n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}("Error ".concat(e.name,": ").concat(e.message))}var h=function(e){var n=e.children,t=function(){var e=(0,o.useState)(null),n=e[0],t=e[1],a=(0,o.useState)("https://signaling.gcp1.ionkom.com"),r=a[0];return a[1],(0,o.useEffect)((function(){var e=(0,i.ZP)(r);return t(e),function(){e.disconnect()}}),[r]),n}(),a=(0,o.useContext)(s.F),u=a.localStream,h=a.remoteStream,g=a.setRemoteStream,m=(0,o.useState)(null),k=m[0],C=m[1],b=(0,o.useRef)(!1),x=(0,o.useRef)(!1),w=(0,o.useRef)(!1),S=(0,o.useState)([]),y=S[0],T=S[1],R=(0,o.useState)(null),E=R[0],U=R[1],I=(0,o.useState)(void 0),D=I[0],P=I[1],j=(0,o.useCallback)((function(e){p("Sending '"+e.type+"' message: "+e),t.emit(e.type,e)}),[t]),N=(0,o.useCallback)((function(){p("Closing the call"),k&&(p("--\x3e Closing the peer connection"),k.ontrack=null,k.onnicecandidate=null,k.oniceconnectionstatechange=null,k.onsignalingstatechange=null,k.onicegatheringstatechange=null,k.onnotificationneeded=null,"close"!=k.connectionState&&k.getTransceivers().forEach((function(e){e.stop()})),h&&h.srcObject&&(h.pause(),h.srcObject.getTracks().forEach((function(e){e.stop()}))),g(null),P(null),k.close(),C(null))}),[k]),L=(0,o.useCallback)((function(){D&&(p("*** Hang up the call"),N(),j({name:E,target:D,type:"hang-up"}))}),[N,j,E,D]),O=(0,o.useCallback)((function(){L(),t.emit("request-a-match",{name:E})}),[t,E,D,L]),W=(0,o.useCallback)((function(e){e.candidate&&(p("*** Outgoing ICE candidate: "+e.candidate.candidate),j({type:"new-ice-candidate",target:D,candidate:e.candidate}))}),[j,D]),_=(0,o.useCallback)((function(e){switch(p("*** ICE connection state changed to "+k.iceConnectionState),k.iceConnectionState){case"closed":case"failed":N()}}),[k,N]),A=(0,o.useCallback)((function(e){p("*** ICE gathering state changed to: "+k.iceGatheringState)}),[k]),H=(0,o.useCallback)((function(e){switch(p("*** WebRTC signaling state changed to: "+k.signalingState),k.signalingState){case"closed":N()}}),[k,N]),q=(0,o.useCallback)(l(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("*** Negotiation needed"),e.prev=1,p("---\x3e Setting local description to the offer"),b.current=!0,e.next=6,k.setLocalDescription();case 6:p("---\x3e Sending the offer to the remote peer"),j({name:E,target:D,type:"video-offer",sdp:k.localDescription}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(1),p("*** The following error occurred while handling the negotiationneeded event:"),v(e.t0);case 14:return e.prev=14,b.current=!1,e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[1,10,14,17]])}))),[k,E,D,j]),z=(0,o.useCallback)((function(e){p("*** Track event: show remote stream"),g(e.streams[0])}),[]);(0,o.useEffect)((function(){k&&(k.onicecandidate=W,k.oniceconnectionstatechange=_,k.onicegatheringstatechange=A,k.onsignalingstatechange=H,k.onnegotiationneeded=q,k.ontrack=z)}),[k,W,_,A,H,q,z]);var F=(0,o.useCallback)(l(r().mark((function e(){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("Setting up a connection..."),n=new RTCPeerConnection(f),C(n),e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)}))),[]),G=(0,o.useCallback)(function(){var e=l(r().mark((function e(n){var t,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p("Starting to prepare an invitation"),!k){e.next=5;break}alert("You can't start a call because you already have one open!"),e.next=17;break;case 5:if((t=n)!==E){e.next=9;break}return alert("I'm afraid I can't let you talk to yourself. That would be weird."),e.abrupt("return");case 9:return P(t),p("Inviting user "+t),p("Setting /up connection to invite user: "+t),e.next=14,F();case 14:a=e.sent,u&&(p("Add the local camera stream to the RTCPeerConnection"),u.getTracks().forEach((function(e){return a.addTransceiver(e,{streams:[u]})})));case 17:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),[k,E,u,F,j,P]);(0,o.useEffect)((function(){var e=function(e){p("*** Received hang up notification from other peer"),N()};if(t){var n=function(e){var n=e.users;p("usr::updateUserList::ids: ".concat(n)),T(n.filter((function(e){return e!=t.id&&e!=D})))},a=function(e){var n=e.socketId;p("usr::removeUser::ids: ".concat(n)),T(y.filter((function(e){return e!=n})))},c=function(e){var n=e.target;n?(p("inviteToCall: ".concat(n)),G(n)):alert("No other users available")};return t.on("connect",(function(){return U(t.id)})),t.on("update-user-list",n),t.on("remove-user",a),t.on("receive-a-match",c),t.on("video-offer",o),t.on("new-ice-candidate",s),t.on("hang-up",e),function(){t.off("update-user-list",n),t.off("remove-user",a),t.off("receive-a-match",c),t.off("video-offer",o),t.off("new-ice-candidate",s),t.off("hang-up",e)}}function o(e){return i.apply(this,arguments)}function i(){return(i=l(r().mark((function e(n){var t,a,c,o,i,s,l,f,d,v,h,g;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.name,a=new RTCSessionDescription(n.sdp),p("Received video chat offer from "+t+"(polite: "+(c=E<t)),P(t),o=k,k){e.next=29;break}return e.next=9,F();case 9:if(o=e.sent,!u){e.next=29;break}for(p("Add the local camera stream to the RTCPeerConnection"),i=!0,s=!1,l=void 0,e.prev=13,f=u.getTracks()[Symbol.iterator]();!(i=(d=f.next()).done);i=!0)v=d.value,o.addTrack(v,u);e.next=21;break;case 17:e.prev=17,e.t0=e.catch(13),s=!0,l=e.t0;case 21:e.prev=21,e.prev=22,i||null==f.return||f.return();case 24:if(e.prev=24,!s){e.next=27;break}throw l;case 27:return e.finish(24);case 28:return e.finish(21);case 29:if(h=!b.current&&("stable"==o.signalingState||w.current),g="offer"==a.type&&!h,x.current=!c&&g,!x.current){e.next=34;break}return e.abrupt("return");case 34:return w.current="answer"==a.type,e.next=37,o.setRemoteDescription(a);case 37:if(w.current=!1,p("@@@Description type: ".concat(a.type)),"offer"!=a.type){e.next=43;break}return e.next=42,o.setLocalDescription();case 42:j({name:E,target:t,type:"video-offer",sdp:o.localDescription});case 43:case 44:case"end":return e.stop()}}),e,null,[[13,17,21,29],[22,,24,28]])})))).apply(this,arguments)}function s(e){return f.apply(this,arguments)}function f(){return(f=l(r().mark((function e(n){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new RTCIceCandidate(n.candidate),p("*** Adding received ICE candidate: "+JSON.stringify(t)),e.prev=2,e.next=5,k.addIceCandidate(t);case 5:e.next=12;break;case 7:if(e.prev=7,e.t0=e.catch(2),x.current){e.next=12;break}throw v(e.t0),e.t0;case 12:case"end":return e.stop()}}),e,null,[[2,7]])})))).apply(this,arguments)}}),[t,k,E,D,u,y,j,N]);var J=(0,o.useCallback)(l(r().mark((function e(){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.emit("join",{name:E});case 1:case"end":return e.stop()}}),e)}))),[t,E,F,u]),K=(0,o.useCallback)((function(){N(),t.emit("stop")}),[t,N]);return(0,c.jsx)(d.Provider,{value:{nextUser:O,joinConv:J,stopConv:K,hangUpCall:L,availableUsers:y,myUsername:E,targetUsername:D,peerConnection:k},children:n})}}}]);