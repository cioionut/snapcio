"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[851],{3851:function(e,n,t){t.r(n),t.d(n,{WebRTCContext:function(){return d},WebRTCContextProvider:function(){return h}});var a=t(4051),r=t.n(a),c=t(5893),i=t(7294),o=t(8158),s=t(7658);function u(e,n,t,a,r,c,i){try{var o=e[c](i),s=o.value}catch(u){return void t(u)}o.done?n(s):Promise.resolve(s).then(a,r)}function l(e){return function(){var n=this,t=arguments;return new Promise((function(a,r){var c=e.apply(n,t);function i(e){u(c,a,r,i,o,"next",e)}function o(e){u(c,a,r,i,o,"throw",e)}i(void 0)}))}}var f={iceServers:[{urls:"stun:".concat("15.161.216.220:3478")},{urls:"turn:".concat("15.161.216.220:3478"),username:"ciousr",credential:"T3mTypEIYYYBT473Lz6g"}]},d=(0,i.createContext)({nextUser:function(){},closeVideoCall:function(){},availableUsers:[],myUsername:void 0});function p(e){var n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function g(e){!function(e){var n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}("Error ".concat(e.name,": ").concat(e.message))}var h=function(e){var n=e.children,t=function(){var e=(0,i.useState)(null),n=e[0],t=e[1],a=(0,i.useState)("https://signaling.ionkom.com"),r=a[0];return a[1],(0,i.useEffect)((function(){var e=(0,o.ZP)(r);return t(e),function(){e.disconnect()}}),[r]),n}(),a=(0,i.useContext)(s.F),u=a.localStream,h=(a.setLocalStream,a.setRemoteStream),v=(0,i.useState)(null),m=v[0],C=v[1],b=(0,i.useState)([null]),k=(b[0],b[1],(0,i.useState)([])),w=k[0],x=k[1],S=(0,i.useState)(null),y=S[0],T=S[1],R=(0,i.useState)(null),E=R[0],D=R[1],I=(0,i.useCallback)((function(e){p("Sending '"+e.type+"' message: "+e),t.emit(e.type,e)}),[t]),P=(0,i.useCallback)((function(){p("Closing the call"),m&&(p("--\x3e Closing the peer connection"),m.ontrack=null,m.onnicecandidate=null,m.oniceconnectionstatechange=null,m.onsignalingstatechange=null,m.onicegatheringstatechange=null,m.onnotificationneeded=null,m.getTransceivers().forEach((function(e){e.stop()})),m.close(),C(null)),D(null)}),[m]),L=(0,i.useCallback)((function(){P(),I({name:y,target:E,type:"hang-up"}),D(null)}),[P,I,y,E]),U=(0,i.useCallback)((function(){E&&L(),t.emit("request-a-match",{name:y})}),[t,y,E,L]),N=(0,i.useCallback)((function(e){e.candidate&&(p("*** Outgoing ICE candidate: "+e.candidate.candidate),I({type:"new-ice-candidate",target:E,candidate:e.candidate}))}),[I,E]),A=(0,i.useCallback)((function(e){switch(p("*** ICE connection state changed to "+m.iceConnectionState),m.iceConnectionState){case"closed":case"failed":case"disconnected":P()}}),[m,P]),Y=(0,i.useCallback)((function(e){p("*** ICE gathering state changed to: "+m.iceGatheringState)}),[m]),_=(0,i.useCallback)((function(e){switch(p("*** WebRTC signaling state changed to: "+m.signalingState),m.signalingState){case"closed":P()}}),[m,P]),O=(0,i.useCallback)(l(r().mark((function e(){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("*** Negotiation needed"),e.prev=1,p("---\x3e Creating offer"),e.next=5,m.createOffer();case 5:if(n=e.sent,"stable"==m.signalingState){e.next=9;break}return p("     -- The connection isn't stable yet; postponing..."),e.abrupt("return");case 9:return p("---\x3e Setting local description to the offer"),e.next=12,m.setLocalDescription(n);case 12:p("---\x3e Sending the offer to the remote peer"),I({name:y,target:E,type:"video-offer",sdp:m.localDescription}),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(1),p("*** The following error occurred while handling the negotiationneeded event:"),g(e.t0);case 20:case 21:case"end":return e.stop()}}),e,null,[[1,16]])}))),[m,y,E,I]),W=(0,i.useCallback)((function(e){p("*** Track event: show remote stream"),h(e.streams[0])}),[]);(0,i.useEffect)((function(){m&&(m.onicecandidate=N,m.oniceconnectionstatechange=A,m.onicegatheringstatechange=Y,m.onsignalingstatechange=_,m.onnegotiationneeded=O,m.ontrack=W)}),[m,N,A,Y,_,O,W]);var B=(0,i.useCallback)(l(r().mark((function e(){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("Setting up a connection..."),n=new RTCPeerConnection(f),C(n),e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)}))),[]),V=(0,i.useCallback)(function(){var e=l(r().mark((function e(n){var t,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p("Starting to prepare an invitation"),!m){e.next=5;break}alert("You can't start a call because you already have one open!"),e.next=17;break;case 5:if((t=n)!==y){e.next=9;break}return alert("I'm afraid I can't let you talk to yourself. That would be weird."),e.abrupt("return");case 9:return D(t),p("Inviting user "+t),p("Setting up connection to invite user: "+t),e.next=14,B();case 14:a=e.sent,u&&(p("Add the local camera stream to the RTCPeerConnection"),u.getTracks().forEach((function(e){return a.addTransceiver(e,{streams:[u]})})));case 17:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),[m,y,u,B,I]);return(0,i.useEffect)((function(){var e=function(e){p("*** Received hang up notification from other peer"),P()};if(t){var n=function(e){var n=e.users;p("updateUserList::ids: ".concat(n)),x(n.filter((function(e){return e!=t.id})))},a=function(e){var n=e.socketId;p("removeUser::ids: ".concat(n)),x(w.filter((function(e){return e!=n})))},c=function(e){var n=e.target;n?(p("inviteToCall: ".concat(n)),V(n)):alert("No other users available")};return t.on("connect",(function(){return T(t.id)})),t.on("update-user-list",n),t.on("remove-user",a),t.on("receive-a-match",c),t.on("video-offer",i),t.on("video-answer",s),t.on("new-ice-candidate",d),t.on("hang-up",e),function(){t.off("update-user-list",n),t.off("remove-user",a),t.off("receive-a-match",c),t.off("video-offer",i),t.off("video-answer",s),t.off("new-ice-candidate",d),t.off("hang-up",e)}}function i(e){return o.apply(this,arguments)}function o(){return(o=l(r().mark((function e(n){var t,a,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=n.name,D(t),a=m,p("Received video chat offer from "+t),m){e.next=8;break}return e.next=7,B();case 7:a=e.sent;case 8:if(c=new RTCSessionDescription(n.sdp),"stable"==a.signalingState){e.next=16;break}return p("  - But the signaling state isn't stable, so triggering rollback"),e.next=13,Promise.all([a.setLocalDescription({type:"rollback"}),a.setRemoteDescription(c)]);case 13:return e.abrupt("return");case 16:return p("  - Setting remote description"),e.next=19,a.setRemoteDescription(c);case 19:return a.getTransceivers().length<=2&&u&&(p("Add the local camera stream to the RTCPeerConnection"),u.getTracks().forEach((function(e){return a.addTransceiver(e,{streams:[u]})}))),p("---\x3e Creating and sending answer to caller"),e.t0=a,e.next=25,a.createAnswer();case 25:return e.t1=e.sent,e.next=28,e.t0.setLocalDescription.call(e.t0,e.t1);case 28:I({name:y,target:t,type:"video-answer",sdp:a.localDescription});case 29:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function s(e){return f.apply(this,arguments)}function f(){return(f=l(r().mark((function e(n){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("*** Call recipient has accepted our call"),t=new RTCSessionDescription(n.sdp),e.next=4,m.setRemoteDescription(t).catch(g);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(e){return h.apply(this,arguments)}function h(){return(h=l(r().mark((function e(n){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new RTCIceCandidate(n.candidate),p("*** Adding received ICE candidate: "+JSON.stringify(t)),e.prev=2,e.next=5,m.addIceCandidate(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),g(e.t0);case 10:case"end":return e.stop()}}),e,null,[[2,7]])})))).apply(this,arguments)}}),[t,m,y,E,u,w,I,P]),(0,c.jsx)(d.Provider,{value:{nextUser:U,closeVideoCall:P,availableUsers:w,myUsername:y},children:n})}}}]);